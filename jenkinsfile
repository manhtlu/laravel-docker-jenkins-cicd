pipeline {
  agent any
  stages {
    stage("Verify tooling") {
      steps {
        sh '''
            docker info
            docker version
            docker compose version
        '''
      }
    }

    stage("Clear all running docker containers") {
      steps {
        script {
          try {
            sh 'docker rm -rf $(docker ps -a -q)'
          } catch (Exception e) {
            echo "No running container to clear up"  
          }
        }
      }
    }

    stage("Start docker") {
      steps {
        // sh 'make up'
        sh 'docker-compose up -d'
        sh 'docker compose ps'
      }
    }

    stage ("Run compose install") {
      steps {
        sh 'docker compose run --rm composer install'
      }
    }

    stage("Run test") {
      steps {
        sh 'docker compose run --rm artisan test'
      }
    }
  }
  post {
    always {
      sh 'docker compose down --remove-orphans -v'
      sh 'docker compose ps'
    }
  }
}